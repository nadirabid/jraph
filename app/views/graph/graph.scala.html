<div class="graph-container">
  <svg class="disable-user-selection" id="graph" v-attr="viewBox:viewBox" v-on="contextmenu:contextMenu">
    <!-- Definitions -->
    <defs>
      <marker
          id="def-marker-arrow"
          markerWidth="2"
          markerHeight="2"
          refx="8"
          refy="1"
          orient="auto"
      >
        <path d="M0,0 L0,2 L2,1 L0,0" class="marker-arrow"></path>
      </marker>
      <marker
          id="def-marker-ghost-arrow"
          markerWidth="2"
          markerHeight="2"
          refx="2"
          refy="1"
          orient="auto"
      >
        <path d="M0,0 L0,2 L2,1 L0,0" class="marker-arrow"></path>
      </marker>
    </defs>

    <!-- Dynamic Content -->
    <g class="dynamic-content" v-el="dynamicContent"></g>

    <!-- Links -->
    <x-link v-repeat="links" track-by="id"></x-link>

    <!-- Nodes -->
    <x-node v-repeat="nodes" track-by="id"></x-node>
  </svg>

  <ul id="contextMenu" class="dropdown-menu hidden" role="menu" style="position:absolute;">
    <li role="presentation" v-on="click:addNode"><a role="menuitem" tabindex="-1">Add Node</a></li>
    <li role="presentation" v-on="click:saveGraph"><a role="menuitem" tabindex="-1">Save Graph</a></li>
  </ul>
</div>

<template id="graph.link">
  <g class="enable-pointer-events">
    <line
      class="link"
      v-attr="x1:source.x, y1:source.y, x2:target.x, y2:target.y"></line>
    <line
        class="marker-arrow"
        marker-end="url(#def-marker-arrow)"
        v-attr="x1:source.x, y1:source.y, x2:target.x, y2:target.y"></line>
  </g>
</template>

<template id="graph.node">
  <g class="node enable-pointer-events" v-attr="id: id, transform: nodeTranslate">
    <circle class="node-circle" v-attr="r:radius + 'em'" v-el="nodeCircle"></circle>
    <text
        class="node-name"
        text-anchor="middle"
        v-attr="transform: nameTranslate"
        v-el="nodeName"
    >
        {{name}} {{$index}}
    </text>
  </g>
</template>

<div class="sidebar-container">
  <div id="panelBar" class="sidebar-menu"></div>
</div>

<template id="node.panel">
  <div class="node-panel">
    <button type="button" class="close" aria-label="Close" v-on="click: cancelAddNode">
      <span aria-hidden="true">&times;</span>
    </button>
    <h3 v-on="dblclick:editName()" v-class="hidden:editingName">{{node.data.name}}</h3>
    <input
        type="text"
        class="form-control input-lg"
        v-model="node.data.name"
        v-class="hidden:!editingName"
        v-el="nameInput"
        v-on="
            blur   : updateName,
            keyup  : updateName       | key enter,
            keyup  : cancelNameUpdate | key esc
        "
    >
    <ul class="list-unstyled">
      <li v-repeat="propsGroup: propertyGroups">
        <dl class="node-property-list">
          <dt>{{$key}}</dt>
          <dd v-repeat="prop: propsGroup">
            <div v-class="hidden:prop.edit_">
                {{prop.value}}
              <button
                  aria-label="Close"
                  class="close"
                  type="button"
                  v-on="click: removeProp(this)"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <input
                type="text"
                class="form-control"
                v-class="hidden:!prop.edit_"
                v-on="
                    blur   : updateProp(this),
                    keyup  : updateProp(this)        | key enter,
                    keyup  : cancelPropUpdate(this)  | key esc
                "
            >
          </dd>
        </dl>
      </li>
      <li class="input-group">
        <input
            class="form-control"
            placeholder="Value"
            type="text"
            v-el="propertyValue"
            v-on="keydown:validateInputChange, paste:validateInputChange"
        >
        <div class="input-group-btn" role="group">
          <button
              type="button"
              class="btn btn-default dropdown-toggle disabled"
              data-toggle="dropdown"
              v-el="addDropdownBtn"
          >
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right" role="menu">
            <li role="presentation" class="dropdown-header">Add as</li>
            <li><a role="menuitem" v-on="click:addPropAs('text')">Text</a></li>
            <li><a role="menuitem" v-on="click:addPropAs('phone')">Phone</a></li>
            <li><a role="menuitem" v-on="click:addPropAs('email')">Email</a></li>
            <li><a role="menuitem" v-on="click:addPropAs('link')">Link</a></li>
          </ul>
        </div>
      </li>
    </ul>
    <button
        class="btn btn-default submit"
        v-class="hidden:!isNew, disabled:!hasChanges"
        v-on="click:createNode"
    >
      Create
    </button>
    <button
        class="btn btn-default submit"
        v-class="hidden:isNew, disabled:!hasChanges"
        v-on="click:saveNode"
    >
      Save
    </button>
  </div>
</template>

@views.html.graph.ghostlink()