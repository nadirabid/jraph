@(hypergraphs: play.api.libs.json.JsValue)

@import play.api.libs.json.Json

<!DOCTYPE html>
<html>
  <head lang="en">
    <meta charset="UTF-8">
    <title>Graphs</title>
    <link rel="stylesheet" href="@routes.Assets.at("style/dependencies/bootstrap.css")">
    <style>
      html, body {
        height: 100%;
      }

      .graphs-list {
        margin-bottom: 0;
      }

      .graphs-list-container {
        background-color: #eee;
        width: 700px;
        margin: 0 auto;
        padding: 0;
      }

      .graph-min-view {
        background-color:#34495E;
      }
    </style>
    <script>

    </script>
  </head>
  <body>
    <div id="graphsListContainer" class="graphs-list-container">
      <dl class="dl-horizontal graphs-list">
        <x-graph-thumbnail v-repeat="hypergraphs"></x-graph-thumbnail>
      </dl>
    </div>

    <template id="graph.thumbnail">
      <dt>{{graph.data.name}}</dt>
      <dd>
        <svg class="graph-min-view" width="500" height="300">
          <defs>
            <marker
                id="def-marker-arrow"
                markerWidth="2"
                markerHeight="2"
                refx="1.5"
                refy="1"
                orient="auto"
            >
              <path d="M0,0 L0,2 L2,1 L0,0" class="marker-arrow"></path>
            </marker>
            <marker
                id="def-marker-ghost-arrow"
                markerWidth="2"
                markerHeight="2"
                refx="0"
                refy="1"
                orient="auto"
            >
              <path d="M0,0 L0,2 L2,1 L0,0" class="marker-arrow"></path>
            </marker>
          </defs>

          <!-- Nodes -->
          <g v-repeat="nodes">
            <g
                class="node enable-pointer-events"
                v-attr="id: id, transform: nodeTranslate"
            >
              <rect
                  class="node-rect"
                  rx="4"
                  ry="4"
                  v-el="nodeRect"
                  v-attr="width:width, height:height, transform:rectTranslate"
              ></rect>
              <text
                  class="node-name disable-pointer-events"
                  text-anchor="middle"
                  v-el="nodeName"
              >
                {{data.name}}
              </text>
            </g>
          </g>

          <!-- Links -->
          <g v-repeat="links">
            <line
                class="link"
                v-attr="x1:sourceX, y1:sourceY, x2:targetClipX, y2:targetClipY"
            ></line>
            <line
                class="marker-arrow"
                marker-end="url(#def-marker-arrow)"
                v-el="arrowMarkerLine"
                v-attr="x1:sourceX, y1:sourceY, x2:targetClipX, y2:targetClipY"
            ></line>
          </g>
        </svg>
      </dd>
    </template>
  </body>
  <script src="@routes.Assets.at("js/dependencies/require.js")"></script>

  <script>

    require.config({
      baseUrl: '/assets/js',
      paths: {
        d3: 'dependencies/d3',
        jquery: 'dependencies/jquery-2.1.1',
        lodash: 'dependencies/lodash',
        mousetrap: 'dependencies/mousetrap',
        q: 'dependencies/q',
        snap: 'dependencies/snap.svg',
        vue: 'dependencies/vue',
        bootstrap: 'dependencies/bootstrap',
        page: 'dependencies/page'
      }
    });

    var userGraphs = @Html(Json.stringify(hypergraphs)); //bootstrap json data into view template
  </script>

  <script>
    require([
        'lodash',
        'jquery',
        'vue',
        'models'
    ],
    function(_, $, Vue, models){

      var Node = models.Node;
      var Link = models.Link;

      var deferredHypergraphsData = _.map(userGraphs, function(hg) {
        return $
            .when(Node.fetchAll(hg.id), Link.fetchAll(hg.id))
            .then(function(nodes, links) {
              nodes.forEach(function (n) {
                links.forEach(function (l) {
                  if (l.sourceId == n.id) l.source = n;
                  if (l.targetId == n.id) l.target = n;
                });
              });

              return {
                graph: hg,
                nodes: nodes,
                links: links
              };
            });
      });

      var GraphThumbnailsContainerComponent = Vue.extend({

        data: function() {
          return {
            hypergraphs :[ ]
          };
        },

        events: {

          'hook:ready': function() {
            var self = this;

            $.when.apply($, deferredHypergraphsData).then(function() {
              self.hypergraphs = Array.prototype.slice.call(arguments);
            });
          }

        }

      });

      var GraphThumbnailComponent = Vue.extend({

        template: '#graph.thumbnail',

        replace: true,

        data: function() {
          return {
            links: [],
            nodes: []
          };
        }

      });

      Vue.component('x-graph-thumbnail', GraphThumbnailComponent);

      // init code
      var graphThumbnailsContainer = new GraphThumbnailsContainerComponent().$mount('#graphsListContainer')
    });
  </script>
</html>